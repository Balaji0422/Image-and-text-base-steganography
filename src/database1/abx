import javax.swing.*;
import javax.swing.event.*;
import java.awt.*;
import java.awt.event.*;
import java.security.MessageDigest;
import java.security.SecureRandom;
import java.util.HashMap;
import java.util.regex.*;

public class HideAndSeekForm extends JFrame {

     private HashMap<String, String> tempPassDB = new HashMap<>();
     private PlaceholderTextField firstNameField;
     private PlaceholderTextField lastNameField;



    JPanel mainPanel, loginPanel, signupPanel;
    boolean isSignupShown = false;

    public HideAndSeekForm() {
        setTitle("Hide & Seek");
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setSize(400, 600);
        setLocationRelativeTo(null);
        setResizable(false);

        JPanel bgPanel = new JPanel() {
            protected void paintComponent(Graphics g) {
                super.paintComponent(g);
                Graphics2D g2d = (Graphics2D) g;
                GradientPaint gp = new GradientPaint(0, 0, new Color(255, 235, 208), getWidth(), getHeight(),
                        new Color(250, 176, 255));
                g2d.setPaint(gp);
                g2d.fillRect(0, 0, getWidth(), getHeight());
            }
        };
        bgPanel.setLayout(new GridBagLayout());

        mainPanel = new JPanel() {
            protected void paintComponent(Graphics g) {
                super.paintComponent(g);
                Graphics2D g2 = (Graphics2D) g.create();
                g2.setColor(Color.WHITE);
                g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                g2.fillRoundRect(0, 0, getWidth(), getHeight(), 36, 36);
                g2.dispose();
            }
        };
        mainPanel.setLayout(new BoxLayout(mainPanel, BoxLayout.Y_AXIS));
        mainPanel.setPreferredSize(new Dimension(340, 520));
        mainPanel.setOpaque(false);
        mainPanel.setBorder(BorderFactory.createEmptyBorder(32, 32, 32, 32));

        buildLoginPanel();
        buildSignupPanel();
        mainPanel.add(loginPanel);

        bgPanel.add(mainPanel);
        setContentPane(bgPanel);
        setVisible(true);
    }

    // Stubbed methods â€” no database calls, just simulate behavior

  private boolean emailExists(String email) {
    String sql = "SELECT 1 FROM users WHERE email = ?";
    try (Connection conn = DBConnection.getConnection();
         PreparedStatement stmt = conn.prepareStatement(sql)) {

        String normalizedEmail = email.toLowerCase().trim();
        stmt.setString(1, normalizedEmail);

        // Debug prints
        System.out.println("Connected DB: " + conn.getCatalog());
        System.out.println("Checking email: [" + normalizedEmail + "]");

        ResultSet rs = stmt.executeQuery();
        boolean exists = rs.next();
        System.out.println("Exists? " + exists);
        return exists;

    } catch (SQLException e) {
        e.printStackTrace();
        return false;
    }
}

private boolean registerUser(String firstName, String lastName, String email, String passwordHash) {
    try (Connection conn = DBConnection.getConnection()) {
        String query = "INSERT INTO users (first_name, last_name, email, password_hash) VALUES (?, ?, ?, ?)";
        PreparedStatement stmt = conn.prepareStatement(query);
        stmt.setString(1, firstName);
        stmt.setString(2, lastName);
        stmt.setString(3, email.toLowerCase().trim());
        stmt.setString(4, passwordHash);
        return stmt.executeUpdate() > 0;
    } catch (SQLException e) {
        e.printStackTrace();
        return false;
    }
}

pivate boolean authenticateUser(String email, String passwordHash) {
        // Stub: simulate authentication (always false here)
        return false;
    }

  private boolean updatePassword(String email, String passwordHash) {
    String sql = "UPDATE users SET password_hash = ? WHERE email = ?";
    try (Connection conn = DBConnection.getConnection();
         PreparedStatement stmt = conn.prepareStatement(sql)) {
        stmt.setString(1, passwordHash);
        stmt.setString(2, email.toLowerCase().trim());
        int rowsUpdated = stmt.executeUpdate();
        System.out.println("Password update for " + email + ": " + (rowsUpdated > 0));
        return rowsUpdated > 0;
    } catch (SQLException e) {
        e.printStackTrace();
        return false;
    }
}

    private void buildLoginPanel() {
        loginPanel = new JPanel();
        loginPanel.setOpaque(false);
        loginPanel.setLayout(new BoxLayout(loginPanel, BoxLayout.Y_AXIS));

        JLabel heading = new JLabel("HIDE & SEEK");
        heading.setFont(new Font("SansSerif", Font.BOLD, 28));
        heading.setAlignmentX(Component.CENTER_ALIGNMENT);

        JLabel subheading = new JLabel("Enter your credential to login:");
        subheading.setFont(new Font("SansSerif", Font.PLAIN, 15));
        subheading.setAlignmentX(Component.CENTER_ALIGNMENT);

        PlaceholderTextField emailField = new PlaceholderTextField("Email");
        stylizeField(emailField);

        JLabel emailIndicator = new JLabel(" ");
        emailIndicator.setFont(new Font("SansSerif", Font.PLAIN, 12));
        emailIndicator.setAlignmentX(Component.LEFT_ALIGNMENT);

        emailField.getDocument().addDocumentListener(new DocumentListener() {
            public void insertUpdate(DocumentEvent e) {
                verifyEmail(emailField, emailIndicator);
            }

            public void removeUpdate(DocumentEvent e) {
                verifyEmail(emailField, emailIndicator);
            }

            public void changedUpdate(DocumentEvent e) {
                verifyEmail(emailField, emailIndicator);
            }
        });

        PlaceholderPasswordField passwordField = new PlaceholderPasswordField("Password");
        stylizeField(passwordField);

        JButton loginButton = new JButton("Login");
        stylizePurpleButton(loginButton);

        JCheckBox showPass = new JCheckBox("Show Password");
        showPass.setFont(new Font("SansSerif", Font.PLAIN, 13));
        showPass.setOpaque(false);
        showPass.addActionListener(e -> {
            passwordField.setEchoChar(showPass.isSelected() ? (char) 0 : 'â€¢');
        });

        JPanel showPassPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 0, 0));
        showPassPanel.setOpaque(false);
        showPassPanel.add(showPass);

        JLabel forgotLabel = new JLabel("<HTML><U>Forgot password?</U></HTML>");
        forgotLabel.setForeground(new Color(160, 32, 240));
        forgotLabel.setFont(new Font("SansSerif", Font.PLAIN, 14));
        forgotLabel.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
        forgotLabel.setAlignmentX(Component.LEFT_ALIGNMENT);
        forgotLabel.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent e) {
                String email = JOptionPane.showInputDialog(mainPanel, "Enter your email to recover password:");
                if (email != null && !email.trim().isEmpty()) {
                    if (emailExists(email)) {
                        String tempPass = generateTempPassword(10);
                        if (updatePassword(email, hashPassword(tempPass))) {
                            tempPassDB.put(email, tempPass);
                            JOptionPane.showMessageDialog(mainPanel, "Temporary password:\n" + tempPass);
                        } else {
                            JOptionPane.showMessageDialog(mainPanel, "Failed to reset password.", "Error",
                                    JOptionPane.ERROR_MESSAGE);
                        }
                    } else {
                        JOptionPane.showMessageDialog(mainPanel, "Email not found.", "Error", JOptionPane.ERROR_MESSAGE);
                    }
                }
            }
        });

        JLabel signupLabel = new JLabel(
                "<HTML>Donâ€™t have an account? <span style='color:#B400E6;text-decoration:underline;cursor:pointer;'>Sign Up</span></HTML>");
        signupLabel.setFont(new Font("SansSerif", Font.PLAIN, 15));
        signupLabel.setAlignmentX(Component.CENTER_ALIGNMENT);
        signupLabel.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
        signupLabel.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent e) {
                if (!isSignupShown) {
                    mainPanel.removeAll();
                    mainPanel.add(signupPanel);
                    mainPanel.revalidate();
                    mainPanel.repaint();
                    isSignupShown = true;
                }
            }
        });

        loginButton.addActionListener(e -> {
            String email = emailField.getText().trim();
            String password = new String(passwordField.getPassword());

            if (!isValidEmail(email)) {
                JOptionPane.showMessageDialog(mainPanel, "Please enter a valid email address.", "Invalid Email",
                        JOptionPane.ERROR_MESSAGE);
                return;
            }
            if (password.isEmpty()) {
                JOptionPane.showMessageDialog(mainPanel, "Password cannot be empty.", "Invalid Password",
                        JOptionPane.ERROR_MESSAGE);
                return;
            }
            String hashPass = hashPassword(password);
            if (authenticateUser(email, hashPass)) {
                if (tempPassDB.containsKey(email) && tempPassDB.get(email).equals(password)) {
                    JOptionPane.showMessageDialog(mainPanel,
                            "You are using a temporary password. Please change your password now.");
                    tempPassDB.remove(email);
                } else {
                    JOptionPane.showMessageDialog(mainPanel, "Login successful!");
                }
            } else {
                JOptionPane.showMessageDialog(mainPanel, "Invalid email or password.", "Login Failed",
                        JOptionPane.ERROR_MESSAGE);
            }
        });

        loginPanel.add(Box.createVerticalStrut(16));
        loginPanel.add(heading);
        loginPanel.add(Box.createVerticalStrut(4));
        loginPanel.add(subheading);
        loginPanel.add(Box.createVerticalStrut(18));
        loginPanel.add(emailField);
        loginPanel.add(emailIndicator);
        loginPanel.add(Box.createVerticalStrut(8));
        loginPanel.add(passwordField);
        loginPanel.add(showPassPanel);
        loginPanel.add(Box.createVerticalStrut(18));
        loginPanel.add(loginButton);
        loginPanel.add(Box.createVerticalStrut(12));
        loginPanel.add(forgotLabel);
        loginPanel.add(Box.createVerticalStrut(18));
        loginPanel.add(signupLabel);
    }

  private void buildSignupPanel() {
    signupPanel = new JPanel();
    signupPanel.setOpaque(false);
    signupPanel.setLayout(new BoxLayout(signupPanel, BoxLayout.Y_AXIS));

    JLabel heading = new JLabel("Sign up");
    heading.setFont(new Font("SansSerif", Font.BOLD, 28));
    heading.setAlignmentX(Component.CENTER_ALIGNMENT);

    JLabel subheading = new JLabel("Create your account");
    subheading.setFont(new Font("SansSerif", Font.PLAIN, 15));
    subheading.setAlignmentX(Component.CENTER_ALIGNMENT);

    // âœ… First name field
    firstNameField = new PlaceholderTextField("First Name");
    stylizeField(firstNameField);

    // âœ… Last name field
    lastNameField = new PlaceholderTextField("Last Name");
    stylizeField(lastNameField);

    // âœ… Email field
    PlaceholderTextField emailField = new PlaceholderTextField("Email");
    stylizeField(emailField);

    JLabel emailIndicator = new JLabel(" ");
    emailIndicator.setFont(new Font("SansSerif", Font.PLAIN, 12));
    emailIndicator.setAlignmentX(Component.LEFT_ALIGNMENT);

    emailField.getDocument().addDocumentListener(new DocumentListener() {
        public void insertUpdate(DocumentEvent e) { verifyEmail(emailField, emailIndicator); }
        public void removeUpdate(DocumentEvent e) { verifyEmail(emailField, emailIndicator); }
        public void changedUpdate(DocumentEvent e) { verifyEmail(emailField, emailIndicator); }
    });

    // âœ… Password fields
    PlaceholderPasswordField passwordField = new PlaceholderPasswordField("Password");
    stylizeField(passwordField);

    PlaceholderPasswordField passwordConfirmField = new PlaceholderPasswordField("Confirm Password");
    stylizeField(passwordConfirmField);

    JCheckBox showPasswordCheck = new JCheckBox("Show Password");
    showPasswordCheck.setOpaque(false);
    showPasswordCheck.addActionListener(e -> {
        boolean show = showPasswordCheck.isSelected();
        passwordField.setEchoChar(show ? (char) 0 : 'â€¢');
        passwordConfirmField.setEchoChar(show ? (char) 0 : 'â€¢');
    });

    JPanel showPassPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 0, 0));
    showPassPanel.setOpaque(false);
    showPassPanel.add(showPasswordCheck);

    // JProgressBar strengthBar = new JProgressBar(0, 100);
    // strengthBar.setStringPainted(true);
    // strengthBar.setMaximumSize(new Dimension(300, 15));

    passwordField.getDocument().addDocumentListener(new DocumentListener() {
        public void insertUpdate(DocumentEvent e) { updateStrength(passwordField, strengthBar); }
        public void removeUpdate(DocumentEvent e) { updateStrength(passwordField, strengthBar); }
        public void changedUpdate(DocumentEvent e) { updateStrength(passwordField, strengthBar); }
    });

    JButton signupButton = new JButton("Sign up");
    stylizeButton(signupButton);

    JLabel loginLabel = new JLabel("<html><u>Already have an account? Login</u></html>");
    loginLabel.setForeground(Color.BLUE.darker());
    loginLabel.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
    loginLabel.setAlignmentX(Component.CENTER_ALIGNMENT);
    loginLabel.addMouseListener(new MouseAdapter() {
        public void mouseClicked(MouseEvent e) {
            showLoginPanel();
        }
    });

    signupButton.addActionListener(e -> {
        String firstName = firstNameField.getText().trim();
        String lastName = lastNameField.getText().trim();
        String email = emailField.getText().trim();
        String password = new String(passwordField.getPassword());
        String confirmPassword = new String(passwordConfirmField.getPassword());

        if (firstName.isEmpty() || lastName.isEmpty() || email.isEmpty() || password.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Please fill in all fields.");
            return;
        }

        if (!password.equals(confirmPassword)) {
            JOptionPane.showMessageDialog(this, "Passwords do not match.");
            return;
        }

        if (registerUser(firstName, lastName, email, hashPassword(password))) {
            JOptionPane.showMessageDialog(this, "Account created successfully!");
            showLoginPanel();
        } else {
            JOptionPane.showMessageDialog(this, "Error creating account. Try again.");
        }
    });
signupPanel.add(Box.createVerticalStrut(16));
signupPanel.add(heading);
signupPanel.add(Box.createVerticalStrut(2));
signupPanel.add(subheading);
signupPanel.add(Box.createVerticalStrut(14));

// ðŸ”¥ Add these lines
signupPanel.add(firstNameField);
signupPanel.add(Box.createVerticalStrut(8));
signupPanel.add(lastNameField);
signupPanel.add(Box.createVerticalStrut(8));

signupPanel.add(emailField);
signupPanel.add(emailIndicator);
signupPanel.add(Box.createVerticalStrut(8));

signupPanel.add(passwordField);
signupPanel.add(passwordConfirmField);
signupPanel.add(showPassPanel);
signupPanel.add(strengthBar);

signupPanel.add(Box.createVerticalStrut(16));
signupPanel.add(signupButton);
signupPanel.add(Box.createVerticalStrut(17));
signupPanel.add(loginLabel);

}

    void stylizeField(JTextField field) {
        field.setBorder(BorderFactory.createCompoundBorder(
                BorderFactory.createLineBorder(new Color(230, 200, 240), 2, true),
                BorderFactory.createEmptyBorder(8, 8, 8, 8)));
        field.setMaximumSize(new Dimension(Integer.MAX_VALUE, 38));
        field.setAlignmentX(Component.CENTER_ALIGNMENT);
    }

    void stylizePurpleButton(JButton btn) {
        btn.setFont(new Font("SansSerif", Font.BOLD, 18));
        btn.setBackground(new Color(160, 32, 240));
        btn.setForeground(Color.WHITE);
        btn.setFocusPainted(false);
        btn.setMaximumSize(new Dimension(Integer.MAX_VALUE, 38));
        btn.setAlignmentX(Component.CENTER_ALIGNMENT);
    }

    void verifyEmail(JTextField field, JLabel indicator) {
        String email = field.getText().trim();
        if (email.isEmpty()) {
            indicator.setText(" ");
            indicator.setForeground(Color.GRAY);
        } else if (isValidEmail(email)) {
            indicator.setText("Valid email");
            indicator.setForeground(new Color(0, 150, 0));
        } else {
            indicator.setText("Invalid email");
            indicator.setForeground(Color.RED);
        }
    }

    void updateStrengthBar(JPasswordField passField, JProgressBar bar) {
        String pass = new String(passField.getPassword());
        int strength = passwordScore(pass);
        bar.setValue(strength);
        if (strength < 40) {
            bar.setString("Weak");
            bar.setForeground(Color.RED);
        } else if (strength < 70) {
            bar.setString("Medium");
            bar.setForeground(Color.ORANGE);
        } else {
            bar.setString("Strong");
            bar.setForeground(new Color(0, 150, 0));
        }
    }

    boolean isValidEmail(String email) {
        String regex = "^[\\w+.-]+@[\\w.-]+\\.[a-zA-Z]{2,}$";
        return Pattern.compile(regex).matcher(email).matches();
    }

    boolean isPasswordStrong(String password) {
        String regex = "^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%^&+=()])(?=\\S+$).{8,20}$";
        return Pattern.compile(regex).matcher(password).matches();
    }

    String hashPassword(String password) {
        try {
            MessageDigest md = MessageDigest.getInstance("SHA-256");
            byte[] hashed = md.digest(password.getBytes("UTF-8"));
            StringBuilder sb = new StringBuilder();
            for (byte b : hashed) {
                sb.append(String.format("%02x", b));
            }
            return sb.toString();
        } catch (Exception e) {
            return null;
        }
    }

    int passwordScore(String pass) {
        int score = 0;
        if (pass.length() >= 8) score += 25;
        if (pass.matches(".*[a-z].*")) score += 15;
        if (pass.matches(".*[A-Z].*")) score += 20;
        if (pass.matches(".*[0-9].*")) score += 20;
        if (pass.matches(".*[@#$%^&+=()].*")) score += 20;
        if (pass.length() > 12) score += 10;
        return Math.min(score, 100);
    }

    String generateTempPassword(int length) {
        String chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#";
        SecureRandom r = new SecureRandom();
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < length; ++i) sb.append(chars.charAt(r.nextInt(chars.length())));
        return sb.toString();
    }

    // Placeholder classes for text and password fields
    private static class PlaceholderTextField extends JTextField {
        private String placeholder;
        public PlaceholderTextField(String placeholder) {
            this.placeholder = placeholder;
        }
        protected void paintComponent(Graphics g) {
            super.paintComponent(g);
            if (getText().isEmpty() && !isFocusOwner()) {
                Graphics2D g2 = (Graphics2D) g.create();
                g2.setColor(Color.GRAY);
                g2.setFont(getFont().deriveFont(Font.PLAIN));
                Insets insets = getInsets();
                FontMetrics fm = g2.getFontMetrics();
                int y = insets.top + fm.getAscent() + ((getHeight() - insets.top - insets.bottom - fm.getHeight()) / 2);
                g2.drawString(placeholder, insets.left + 4, y);
                g2.dispose();
            }
        }
    }

    private static class PlaceholderPasswordField extends JPasswordField {
        private String placeholder;
        public PlaceholderPasswordField(String placeholder) {
            this.placeholder = placeholder;
        }
        protected void paintComponent(Graphics g) {
            super.paintComponent(g);
            if (getPassword().length == 0 && !isFocusOwner()) {
                Graphics2D g2 = (Graphics2D) g.create();
                g2.setColor(Color.GRAY);
                g2.setFont(getFont().deriveFont(Font.PLAIN));
                Insets insets = getInsets();
                FontMetrics fm = g2.getFontMetrics();
                int y = insets.top + fm.getAscent() + ((getHeight() - insets.top - insets.bottom - fm.getHeight()) / 2);
                g2.drawString(placeholder, insets.left + 4, y);
                g2.dispose();
            }
        }
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(HideAndSeekForm::new);
    }
}
